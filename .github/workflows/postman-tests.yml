# =============================================================================
# GitHub Actions — Postman CLI Regression Suite
# =============================================================================
# Runs the Payroll API regression tests using the official Postman CLI inside
# an Ubuntu 22.04 container. Collection and environment are fetched from the
# Postman cloud workspace — no local JSON exports required.
#
# Required GitHub Secrets:
#   POSTMAN_API_KEY  — Postman API key for authentication
#   COLLECTION_ID    — Postman Collection UID
#   ENVIRONMENT_ID   — Postman Environment UID
#   BASE_URL         — Staging / target API base URL
#   AUTH_TOKEN        — Bearer token for authenticated endpoints
# =============================================================================

name: Payroll API — Postman Regression Tests

# ── Triggers ─────────────────────────────────────────────────────────────────
on:
  # Run on every pull request targeting main
  pull_request:
    branches:
      - main

  # Run on every push (merge) to main
  push:
    branches:
      - main

  # Nightly scheduled run (02:00 UTC every day)
  schedule:
    - cron: "0 2 * * *"

  # Allow manual trigger from the Actions UI
  workflow_dispatch:

# ── Jobs ─────────────────────────────────────────────────────────────────────
jobs:
  postman-regression:
    name: Run Postman Regression Suite
    runs-on: ubuntu-latest

    # Run the entire job inside an Ubuntu 22.04 container for consistency
    container:
      image: ubuntu:22.04

    steps:
      # ── 1. Checkout repository ─────────────────────────────────────────────
      # Required so the workflow has access to the repo context (e.g., PR info)
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Install system dependencies ─────────────────────────────────────
      # curl + ca-certificates are needed by the Postman CLI installer
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends curl ca-certificates
          rm -rf /var/lib/apt/lists/*

      # ── 3. Validate Secrets ────────────────────────────────────────────────
      # Fails fast with a clear message if any are missing.
      - name: Validate Secrets
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          COLLECTION_ID: ${{ secrets.COLLECTION_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
          BASE_URL: ${{ secrets.BASE_URL }}
          AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}
        run: |
          MISSING=0
          if [[ -z "$POSTMAN_API_KEY" ]]; then echo "❌ Error: Secret 'POSTMAN_API_KEY' is missing"; MISSING=1; fi
          if [[ -z "$COLLECTION_ID" ]]; then echo "❌ Error: Secret 'COLLECTION_ID' is missing"; MISSING=1; fi
          if [[ -z "$ENVIRONMENT_ID" ]]; then echo "❌ Error: Secret 'ENVIRONMENT_ID' is missing"; MISSING=1; fi
          if [[ -z "$BASE_URL" ]]; then echo "❌ Error: Secret 'BASE_URL' is missing"; MISSING=1; fi
          if [[ -z "$AUTH_TOKEN" ]]; then echo "❌ Error: Secret 'AUTH_TOKEN' is missing"; MISSING=1; fi
          
          if [[ "$MISSING" -eq 1 ]]; then
            echo "--------------------------------------------------------"
            echo "Please configure these secrets in your GitHub Repository:"
            echo "Settings > Secrets and variables > Actions > New repository secret"
            echo "--------------------------------------------------------"
            exit 1
          fi

      # ── 4. Install Postman CLI ─────────────────────────────────────────────
      # Uses the official Postman installer script for linux64
      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh

      # ── 4. Create artifacts output directory ───────────────────────────────
      - name: Create artifacts directory
        run: mkdir -p artifacts

      # ── 5. Run the Postman collection ──────────────────────────────────────
      # - POSTMAN_API_KEY is passed as an env var; the CLI auto-authenticates
      #   (no explicit `postman login` needed — it fails in headless CI)
      # - Collection and environment are referenced by UID (fetched from cloud)
      # - base_url and auth_token are injected via --env-var overrides
      # - Reports: cli (stdout), html, junit (for CI parsers), json
      # - --bail: fail fast on first assertion error
      # - --verbose: detailed request/response logging
      - name: Run Postman collection
        env:
          RAW_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          RAW_COLLECTION_ID: ${{ secrets.COLLECTION_ID }}
          RAW_ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
          RAW_BASE_URL: ${{ secrets.BASE_URL }}
          RAW_AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}
        run: |
          # ── Sanitize Secrets ───────────────────────────────────────────────────
          # Strip accidental newlines/whitespace that break shell commands
          export POSTMAN_API_KEY=$(echo "$RAW_API_KEY" | tr -d '\r\n')
          export COLLECTION_ID=$(echo "$RAW_COLLECTION_ID" | tr -d '\r\n')
          export ENVIRONMENT_ID=$(echo "$RAW_ENVIRONMENT_ID" | tr -d '\r\n')
          export BASE_URL=$(echo "$RAW_BASE_URL" | tr -d '\r\n')
          export AUTH_TOKEN=$(echo "$RAW_AUTH_TOKEN" | tr -d '\r\n')

          # ── Debug Info (Secrets are masked by GitHub) ──────────────────────────
          echo "Running collection: $COLLECTION_ID"
          echo "Environment: $ENVIRONMENT_ID"
          echo "Base URL: $BASE_URL"

          # ── Execute ────────────────────────────────────────────────────────────
          postman collection run "$COLLECTION_ID" \
            --environment "$ENVIRONMENT_ID" \
            --env-var "base_url=$BASE_URL" \
            --env-var "auth_token=$AUTH_TOKEN" \
            --reporters cli,html,junit,json \
            --reporter-html-export artifacts/report.html \
            --reporter-junit-export artifacts/results.xml \
            --reporter-json-export artifacts/results.json \
            --bail \
            --verbose

      # ── 7. Upload test artifacts ───────────────────────────────────────────
      # Artifacts are uploaded regardless of test pass/fail so engineers can
      # inspect HTML reports, JUnit XML (for test-summary tools), and raw JSON.
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: postman-regression-results
          path: artifacts/
          retention-days: 30
